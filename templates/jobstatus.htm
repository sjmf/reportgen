<!DOCTYPE html>

<title>Job status</title>
<!-- Online resources -->
<link rel="stylesheet" href="http://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">

<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>


<style type="text/css">
nav.top-nav a.page-title {line-height: 122px; font-size: 48px; }
nav.top-nav { height: 122px; }
.caption {font-size: 1.25rem; font-weight: 300; }
</style>

<meta name="viewport" content="width=device-width, initial-scale=1.0"/>


<nav class="top-nav indigo darken-1">
  <div class="container">
    <div class="nav-wrapper"> <a class="page-title">BAX Report Generator</a> </div>
  </div>
</nav>

<main>
<div class="container"><div class="section">

<div class="row"><div class="col s12">
  
  <div class="card {% if not running and not done %}hide{% endif %}"><div class="card-content">
    <div class="row"><div class="col s12">

      <span class="card-title">Report job</span>
      <table>
        <thead>
          <tr>
              <th data-field="location">Location</th>
              <th data-field="description">Description</th>
              <th data-field="map-file">Map</th>
              <th class="right-align" data-field="cancel">Remove</th>
              {% if done %}
              <th class="right-align" data-field="download">Download</th>
              {% endif %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>{{ location }}</strong></td>
            <td>{{ description }}</td>
            <td>{{ map_file }}</td>
            <td class="right-align">
              <a id="cancel" class="btn-floating waves-effect waves-light red lighten-1 white-text">
                <i class="material-icons right">delete</i>
              </a>
            </td>
            {% if done %}
            <td class="right-align">
              <a id="download" href="/download" class="btn-floating waves-effect waves-light blue white-text">
                <i class="material-icons right">play_for_work</i>
              </a>
            </td>
            {% endif %}
          </tr>
        </tbody>
      </table>
    </div></div><!--row, col s12-->

    <div class="row"><div class="col s12">
      <p><strong>Files:</strong>
      {% for file in files %}
      {{ file.original_name }}{% if not loop.last %},{% endif %}
      {% endfor %} 
      </p>
    </div></div><!--row, col s12-->
  </div></div><!--card, card-content-->

  <div class="card {% if not running %}hide{% endif %}"><div class="card-content">
    <div class="row"><div class="col s12">

      <span class="card-title">Log output</span>
      <code class="job-output">
        <pre>{% if job_output %} {{ job_output }} {% else %} No output yet... {% endif %}
        </pre>
      </code>

      <div id="upload-progress" class="progress indigo darken-1">
        <div class="indeterminate blue "></div>
      </div>
<!--
      <p class="right-align">
        <input type="checkbox" id="autoreload" checked="checked" class="filled-in"/> 
        <label for="autoreload">Autoreload?</label>
      </p>
-->
    </div></div><!--row, col s12-->
</div></div><!--card, card-content-->

  <div id="output-card" class="card {% if running %}hide{% endif %}"><div class="card-content">
    <div class="row"><div class="col s12">
      <span class="card-title">Status</span>
      {% if done %}
      <div class="job-output caption">
         Job complete. Download file above or remove it to generate another. 
      </div>
      {% else %}
      <div class="job-output caption">
          No job running. Please submit one <a href='/'>here</a>.
      </div>
      {% endif %}
    </div></div><!--row, col s12-->
  </div></div><!--card, card-content-->
</div></div><!--row, col s12-->

</div><!--section-->


<script type="text/javascript">
INTERVAL = 2000

$(function(){
  True=true; False=false; 

  reload = function(){ 
    $.getJSON('/status', function(data) {
      console.log(data) 

      if ("output" in data)
        $('.job-output pre').text(data.output)
      if (data.status == 'done'){
        window.location = '/job' 
      }
      timeout = setTimeout(reload, INTERVAL)
    })
  }

  $('.job-output pre').text( $('.job-output pre').text().trim() )

  if( {{running}} ) {// && $('#autoreload').is(":checked")) {
    timeout = setTimeout(reload, INTERVAL)
  }

  // HANDLERS
  console.log("register handlers")
  $("#autoreload").change(function(e){
    console.info("autoreload change")
    clearTimeout(timeout)
    if(this.checked) {
      timeout = setTimeout(reload, INTERVAL)
    }
  })

  $("#cancel").click(function(e){  
    $.post('/cancel', function(files) {
      console.log("Job cancelled")
      window.location = '/' 
    })
  })
})
</script>
